(function(){"use strict";const De=Symbol("Comlink.proxy"),it=Symbol("Comlink.endpoint"),st=Symbol("Comlink.releaseProxy"),me=Symbol("Comlink.thrown"),Oe=i=>typeof i=="object"&&i!==null||typeof i=="function",ct={canHandle:i=>Oe(i)&&i[De],serialize(i){const{port1:s,port2:v}=new MessageChannel;return ye(i,s),[v,[v]]},deserialize(i){return i.start(),lt(i)}},ft={canHandle:i=>Oe(i)&&me in i,serialize({value:i}){let s;return i instanceof Error?s={isError:!0,value:{message:i.message,name:i.name,stack:i.stack}}:s={isError:!1,value:i},[s,[]]},deserialize(i){throw i.isError?Object.assign(new Error(i.value.message),i.value):i.value}},ke=new Map([["proxy",ct],["throw",ft]]);function ye(i,s=self){s.addEventListener("message",function v(d){if(!d||!d.data)return;const{id:y,type:_,path:g}=Object.assign({path:[]},d.data),b=(d.data.argumentList||[]).map(Z);let x;try{const S=g.slice(0,-1).reduce((u,E)=>u[E],i),k=g.reduce((u,E)=>u[E],i);switch(_){case"GET":x=k;break;case"SET":S[g.slice(-1)[0]]=Z(d.data.value),x=!0;break;case"APPLY":x=k.apply(S,b);break;case"CONSTRUCT":{const u=new k(...b);x=vt(u)}break;case"ENDPOINT":{const{port1:u,port2:E}=new MessageChannel;ye(i,E),x=ht(u,[u])}break;case"RELEASE":x=void 0;break;default:return}}catch(S){x={value:S,[me]:0}}Promise.resolve(x).catch(S=>({value:S,[me]:0})).then(S=>{const[k,u]=ge(S);s.postMessage(Object.assign(Object.assign({},k),{id:y}),u),_==="RELEASE"&&(s.removeEventListener("message",v),Pe(s))})}),s.start&&s.start()}function ut(i){return i.constructor.name==="MessagePort"}function Pe(i){ut(i)&&i.close()}function lt(i,s){return pe(i,[],s)}function fe(i){if(i)throw new Error("Proxy has been released and is not useable")}function pe(i,s=[],v=function(){}){let d=!1;const y=new Proxy(v,{get(_,g){if(fe(d),g===st)return()=>ee(i,{type:"RELEASE",path:s.map(b=>b.toString())}).then(()=>{Pe(i),d=!0});if(g==="then"){if(s.length===0)return{then:()=>y};const b=ee(i,{type:"GET",path:s.map(x=>x.toString())}).then(Z);return b.then.bind(b)}return pe(i,[...s,g])},set(_,g,b){fe(d);const[x,S]=ge(b);return ee(i,{type:"SET",path:[...s,g].map(k=>k.toString()),value:x},S).then(Z)},apply(_,g,b){fe(d);const x=s[s.length-1];if(x===it)return ee(i,{type:"ENDPOINT"}).then(Z);if(x==="bind")return pe(i,s.slice(0,-1));const[S,k]=Ce(b);return ee(i,{type:"APPLY",path:s.map(u=>u.toString()),argumentList:S},k).then(Z)},construct(_,g){fe(d);const[b,x]=Ce(g);return ee(i,{type:"CONSTRUCT",path:s.map(S=>S.toString()),argumentList:b},x).then(Z)}});return y}function dt(i){return Array.prototype.concat.apply([],i)}function Ce(i){const s=i.map(ge);return[s.map(v=>v[0]),dt(s.map(v=>v[1]))]}const Le=new WeakMap;function ht(i,s){return Le.set(i,s),i}function vt(i){return Object.assign(i,{[De]:!0})}function ge(i){for(const[s,v]of ke)if(v.canHandle(i)){const[d,y]=v.serialize(i);return[{type:"HANDLER",name:s,value:d},y]}return[{type:"RAW",value:i},Le.get(i)||[]]}function Z(i){switch(i.type){case"HANDLER":return ke.get(i.name).deserialize(i.value);case"RAW":return i.value}}function ee(i,s,v){return new Promise(d=>{const y=mt();i.addEventListener("message",function _(g){!g.data||!g.data.id||g.data.id!==y||(i.removeEventListener("message",_),d(g.data))}),i.start&&i.start(),i.postMessage(Object.assign({id:y},s),v)})}function mt(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var ue=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function yt(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function le(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Fe={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(i,s){(function(v){i.exports=v()})(function(){return function v(d,y,_){function g(S,k){if(!y[S]){if(!d[S]){var u=typeof le=="function"&&le;if(!k&&u)return u(S,!0);if(b)return b(S,!0);var E=new Error("Cannot find module '"+S+"'");throw E.code="MODULE_NOT_FOUND",E}var R=y[S]={exports:{}};d[S][0].call(R.exports,function(P){var z=d[S][1][P];return g(z||P)},R,R.exports,v,d,y,_)}return y[S].exports}for(var b=typeof le=="function"&&le,x=0;x<_.length;x++)g(_[x]);return g}({1:[function(v,d,y){(function(_){var g=_.MutationObserver||_.WebKitMutationObserver,b;if(g){var x=0,S=new g(P),k=_.document.createTextNode("");S.observe(k,{characterData:!0}),b=function(){k.data=x=++x%2}}else if(!_.setImmediate&&typeof _.MessageChannel<"u"){var u=new _.MessageChannel;u.port1.onmessage=P,b=function(){u.port2.postMessage(0)}}else"document"in _&&"onreadystatechange"in _.document.createElement("script")?b=function(){var F=_.document.createElement("script");F.onreadystatechange=function(){P(),F.onreadystatechange=null,F.parentNode.removeChild(F),F=null},_.document.documentElement.appendChild(F)}:b=function(){setTimeout(P,0)};var E,R=[];function P(){E=!0;for(var F,H,B=R.length;B;){for(H=R,R=[],F=-1;++F<B;)H[F]();B=R.length}E=!1}d.exports=z;function z(F){R.push(F)===1&&!E&&b()}}).call(this,typeof ue<"u"?ue:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(v,d,y){var _=v(1);function g(){}var b={},x=["REJECTED"],S=["FULFILLED"],k=["PENDING"];d.exports=u;function u(p){if(typeof p!="function")throw new TypeError("resolver must be a function");this.state=k,this.queue=[],this.outcome=void 0,p!==g&&z(this,p)}u.prototype.catch=function(p){return this.then(null,p)},u.prototype.then=function(p,T){if(typeof p!="function"&&this.state===S||typeof T!="function"&&this.state===x)return this;var N=new this.constructor(g);if(this.state!==k){var O=this.state===S?p:T;R(N,O,this.outcome)}else this.queue.push(new E(N,p,T));return N};function E(p,T,N){this.promise=p,typeof T=="function"&&(this.onFulfilled=T,this.callFulfilled=this.otherCallFulfilled),typeof N=="function"&&(this.onRejected=N,this.callRejected=this.otherCallRejected)}E.prototype.callFulfilled=function(p){b.resolve(this.promise,p)},E.prototype.otherCallFulfilled=function(p){R(this.promise,this.onFulfilled,p)},E.prototype.callRejected=function(p){b.reject(this.promise,p)},E.prototype.otherCallRejected=function(p){R(this.promise,this.onRejected,p)};function R(p,T,N){_(function(){var O;try{O=T(N)}catch(M){return b.reject(p,M)}O===p?b.reject(p,new TypeError("Cannot resolve promise with itself")):b.resolve(p,O)})}b.resolve=function(p,T){var N=F(P,T);if(N.status==="error")return b.reject(p,N.value);var O=N.value;if(O)z(p,O);else{p.state=S,p.outcome=T;for(var M=-1,U=p.queue.length;++M<U;)p.queue[M].callFulfilled(T)}return p},b.reject=function(p,T){p.state=x,p.outcome=T;for(var N=-1,O=p.queue.length;++N<O;)p.queue[N].callRejected(T);return p};function P(p){var T=p&&p.then;if(p&&(typeof p=="object"||typeof p=="function")&&typeof T=="function")return function(){T.apply(p,arguments)}}function z(p,T){var N=!1;function O(W){N||(N=!0,b.reject(p,W))}function M(W){N||(N=!0,b.resolve(p,W))}function U(){T(M,O)}var $=F(U);$.status==="error"&&O($.value)}function F(p,T){var N={};try{N.value=p(T),N.status="success"}catch(O){N.status="error",N.value=O}return N}u.resolve=H;function H(p){return p instanceof this?p:b.resolve(new this(g),p)}u.reject=B;function B(p){var T=new this(g);return b.reject(T,p)}u.all=be;function be(p){var T=this;if(Object.prototype.toString.call(p)!=="[object Array]")return this.reject(new TypeError("must be an array"));var N=p.length,O=!1;if(!N)return this.resolve([]);for(var M=new Array(N),U=0,$=-1,W=new this(g);++$<N;)G(p[$],$);return W;function G(ie,de){T.resolve(ie).then(we,function(ne){O||(O=!0,b.reject(W,ne))});function we(ne){M[de]=ne,++U===N&&!O&&(O=!0,b.resolve(W,M))}}}u.race=q;function q(p){var T=this;if(Object.prototype.toString.call(p)!=="[object Array]")return this.reject(new TypeError("must be an array"));var N=p.length,O=!1;if(!N)return this.resolve([]);for(var M=-1,U=new this(g);++M<N;)$(p[M]);return U;function $(W){T.resolve(W).then(function(G){O||(O=!0,b.resolve(U,G))},function(G){O||(O=!0,b.reject(U,G))})}}},{1:1}],3:[function(v,d,y){(function(_){typeof _.Promise!="function"&&(_.Promise=v(2))}).call(this,typeof ue<"u"?ue:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(v,d,y){var _=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function g(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function b(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var x=b();function S(){try{if(!x||!x.open)return!1;var e=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),n=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!e||n)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function k(e,n){e=e||[],n=n||{};try{return new Blob(e,n)}catch(r){if(r.name!=="TypeError")throw r;for(var t=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,o=new t,a=0;a<e.length;a+=1)o.append(e[a]);return o.getBlob(n.type)}}typeof Promise>"u"&&v(3);var u=Promise;function E(e,n){n&&e.then(function(t){n(null,t)},function(t){n(t)})}function R(e,n,t){typeof n=="function"&&e.then(n),typeof t=="function"&&e.catch(t)}function P(e){return typeof e!="string"&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function z(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var F="local-forage-detect-blob-support",H=void 0,B={},be=Object.prototype.toString,q="readonly",p="readwrite";function T(e){for(var n=e.length,t=new ArrayBuffer(n),o=new Uint8Array(t),a=0;a<n;a++)o[a]=e.charCodeAt(a);return t}function N(e){return new u(function(n){var t=e.transaction(F,p),o=k([""]);t.objectStore(F).put(o,"key"),t.onabort=function(a){a.preventDefault(),a.stopPropagation(),n(!1)},t.oncomplete=function(){var a=navigator.userAgent.match(/Chrome\/(\d+)/),r=navigator.userAgent.match(/Edge\//);n(r||!a||parseInt(a[1],10)>=43)}}).catch(function(){return!1})}function O(e){return typeof H=="boolean"?u.resolve(H):N(e).then(function(n){return H=n,H})}function M(e){var n=B[e.name],t={};t.promise=new u(function(o,a){t.resolve=o,t.reject=a}),n.deferredOperations.push(t),n.dbReady?n.dbReady=n.dbReady.then(function(){return t.promise}):n.dbReady=t.promise}function U(e){var n=B[e.name],t=n.deferredOperations.pop();if(t)return t.resolve(),t.promise}function $(e,n){var t=B[e.name],o=t.deferredOperations.pop();if(o)return o.reject(n),o.promise}function W(e,n){return new u(function(t,o){if(B[e.name]=B[e.name]||$e(),e.db)if(n)M(e),e.db.close();else return t(e.db);var a=[e.name];n&&a.push(e.version);var r=x.open.apply(x,a);n&&(r.onupgradeneeded=function(c){var f=r.result;try{f.createObjectStore(e.storeName),c.oldVersion<=1&&f.createObjectStore(F)}catch(l){if(l.name==="ConstraintError")console.warn('The database "'+e.name+'" has been upgraded from version '+c.oldVersion+" to version "+c.newVersion+', but the storage "'+e.storeName+'" already exists.');else throw l}}),r.onerror=function(c){c.preventDefault(),o(r.error)},r.onsuccess=function(){var c=r.result;c.onversionchange=function(f){f.target.close()},t(c),U(e)}})}function G(e){return W(e,!1)}function ie(e){return W(e,!0)}function de(e,n){if(!e.db)return!0;var t=!e.db.objectStoreNames.contains(e.storeName),o=e.version<e.db.version,a=e.version>e.db.version;if(o&&(e.version!==n&&console.warn('The database "'+e.name+`" can't be downgraded from version `+e.db.version+" to version "+e.version+"."),e.version=e.db.version),a||t){if(t){var r=e.db.version+1;r>e.version&&(e.version=r)}return!0}return!1}function we(e){return new u(function(n,t){var o=new FileReader;o.onerror=t,o.onloadend=function(a){var r=btoa(a.target.result||"");n({__local_forage_encoded_blob:!0,data:r,type:e.type})},o.readAsBinaryString(e)})}function ne(e){var n=T(atob(e.data));return k([n],{type:e.type})}function Ue(e){return e&&e.__local_forage_encoded_blob}function _t(e){var n=this,t=n._initReady().then(function(){var o=B[n._dbInfo.name];if(o&&o.dbReady)return o.dbReady});return R(t,e,e),t}function Et(e){M(e);for(var n=B[e.name],t=n.forages,o=0;o<t.length;o++){var a=t[o];a._dbInfo.db&&(a._dbInfo.db.close(),a._dbInfo.db=null)}return e.db=null,G(e).then(function(r){return e.db=r,de(e)?ie(e):r}).then(function(r){e.db=n.db=r;for(var c=0;c<t.length;c++)t[c]._dbInfo.db=r}).catch(function(r){throw $(e,r),r})}function Q(e,n,t,o){o===void 0&&(o=1);try{var a=e.db.transaction(e.storeName,n);t(null,a)}catch(r){if(o>0&&(!e.db||r.name==="InvalidStateError"||r.name==="NotFoundError"))return u.resolve().then(function(){if(!e.db||r.name==="NotFoundError"&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),ie(e)}).then(function(){return Et(e).then(function(){Q(e,n,t,o-1)})}).catch(t);t(r)}}function $e(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function xt(e){var n=this,t={db:null};if(e)for(var o in e)t[o]=e[o];var a=B[t.name];a||(a=$e(),B[t.name]=a),a.forages.push(n),n._initReady||(n._initReady=n.ready,n.ready=_t);var r=[];function c(){return u.resolve()}for(var f=0;f<a.forages.length;f++){var l=a.forages[f];l!==n&&r.push(l._initReady().catch(c))}var h=a.forages.slice(0);return u.all(r).then(function(){return t.db=a.db,G(t)}).then(function(m){return t.db=m,de(t,n._defaultConfig.version)?ie(t):m}).then(function(m){t.db=a.db=m,n._dbInfo=t;for(var w=0;w<h.length;w++){var I=h[w];I!==n&&(I._dbInfo.db=t.db,I._dbInfo.version=t.version)}})}function St(e,n){var t=this;e=P(e);var o=new u(function(a,r){t.ready().then(function(){Q(t._dbInfo,q,function(c,f){if(c)return r(c);try{var l=f.objectStore(t._dbInfo.storeName),h=l.get(e);h.onsuccess=function(){var m=h.result;m===void 0&&(m=null),Ue(m)&&(m=ne(m)),a(m)},h.onerror=function(){r(h.error)}}catch(m){r(m)}})}).catch(r)});return E(o,n),o}function It(e,n){var t=this,o=new u(function(a,r){t.ready().then(function(){Q(t._dbInfo,q,function(c,f){if(c)return r(c);try{var l=f.objectStore(t._dbInfo.storeName),h=l.openCursor(),m=1;h.onsuccess=function(){var w=h.result;if(w){var I=w.value;Ue(I)&&(I=ne(I));var A=e(I,w.key,m++);A!==void 0?a(A):w.continue()}else a()},h.onerror=function(){r(h.error)}}catch(w){r(w)}})}).catch(r)});return E(o,n),o}function Nt(e,n,t){var o=this;e=P(e);var a=new u(function(r,c){var f;o.ready().then(function(){return f=o._dbInfo,be.call(n)==="[object Blob]"?O(f.db).then(function(l){return l?n:we(n)}):n}).then(function(l){Q(o._dbInfo,p,function(h,m){if(h)return c(h);try{var w=m.objectStore(o._dbInfo.storeName);l===null&&(l=void 0);var I=w.put(l,e);m.oncomplete=function(){l===void 0&&(l=null),r(l)},m.onabort=m.onerror=function(){var A=I.error?I.error:I.transaction.error;c(A)}}catch(A){c(A)}})}).catch(c)});return E(a,t),a}function Rt(e,n){var t=this;e=P(e);var o=new u(function(a,r){t.ready().then(function(){Q(t._dbInfo,p,function(c,f){if(c)return r(c);try{var l=f.objectStore(t._dbInfo.storeName),h=l.delete(e);f.oncomplete=function(){a()},f.onerror=function(){r(h.error)},f.onabort=function(){var m=h.error?h.error:h.transaction.error;r(m)}}catch(m){r(m)}})}).catch(r)});return E(o,n),o}function Tt(e){var n=this,t=new u(function(o,a){n.ready().then(function(){Q(n._dbInfo,p,function(r,c){if(r)return a(r);try{var f=c.objectStore(n._dbInfo.storeName),l=f.clear();c.oncomplete=function(){o()},c.onabort=c.onerror=function(){var h=l.error?l.error:l.transaction.error;a(h)}}catch(h){a(h)}})}).catch(a)});return E(t,e),t}function At(e){var n=this,t=new u(function(o,a){n.ready().then(function(){Q(n._dbInfo,q,function(r,c){if(r)return a(r);try{var f=c.objectStore(n._dbInfo.storeName),l=f.count();l.onsuccess=function(){o(l.result)},l.onerror=function(){a(l.error)}}catch(h){a(h)}})}).catch(a)});return E(t,e),t}function Dt(e,n){var t=this,o=new u(function(a,r){if(e<0){a(null);return}t.ready().then(function(){Q(t._dbInfo,q,function(c,f){if(c)return r(c);try{var l=f.objectStore(t._dbInfo.storeName),h=!1,m=l.openKeyCursor();m.onsuccess=function(){var w=m.result;if(!w){a(null);return}e===0||h?a(w.key):(h=!0,w.advance(e))},m.onerror=function(){r(m.error)}}catch(w){r(w)}})}).catch(r)});return E(o,n),o}function Ot(e){var n=this,t=new u(function(o,a){n.ready().then(function(){Q(n._dbInfo,q,function(r,c){if(r)return a(r);try{var f=c.objectStore(n._dbInfo.storeName),l=f.openKeyCursor(),h=[];l.onsuccess=function(){var m=l.result;if(!m){o(h);return}h.push(m.key),m.continue()},l.onerror=function(){a(l.error)}}catch(m){a(m)}})}).catch(a)});return E(t,e),t}function kt(e,n){n=z.apply(this,arguments);var t=this.config();e=typeof e!="function"&&e||{},e.name||(e.name=e.name||t.name,e.storeName=e.storeName||t.storeName);var o=this,a;if(!e.name)a=u.reject("Invalid arguments");else{var r=e.name===t.name&&o._dbInfo.db,c=r?u.resolve(o._dbInfo.db):G(e).then(function(f){var l=B[e.name],h=l.forages;l.db=f;for(var m=0;m<h.length;m++)h[m]._dbInfo.db=f;return f});e.storeName?a=c.then(function(f){if(f.objectStoreNames.contains(e.storeName)){var l=f.version+1;M(e);var h=B[e.name],m=h.forages;f.close();for(var w=0;w<m.length;w++){var I=m[w];I._dbInfo.db=null,I._dbInfo.version=l}var A=new u(function(D,L){var C=x.open(e.name,l);C.onerror=function(Y){var ce=C.result;ce.close(),L(Y)},C.onupgradeneeded=function(){var Y=C.result;Y.deleteObjectStore(e.storeName)},C.onsuccess=function(){var Y=C.result;Y.close(),D(Y)}});return A.then(function(D){h.db=D;for(var L=0;L<m.length;L++){var C=m[L];C._dbInfo.db=D,U(C._dbInfo)}}).catch(function(D){throw($(e,D)||u.resolve()).catch(function(){}),D})}}):a=c.then(function(f){M(e);var l=B[e.name],h=l.forages;f.close();for(var m=0;m<h.length;m++){var w=h[m];w._dbInfo.db=null}var I=new u(function(A,D){var L=x.deleteDatabase(e.name);L.onerror=function(){var C=L.result;C&&C.close(),D(L.error)},L.onblocked=function(){console.warn('dropInstance blocked for database "'+e.name+'" until all open connections are closed')},L.onsuccess=function(){var C=L.result;C&&C.close(),A(C)}});return I.then(function(A){l.db=A;for(var D=0;D<h.length;D++){var L=h[D];U(L._dbInfo)}}).catch(function(A){throw($(e,A)||u.resolve()).catch(function(){}),A})})}return E(a,n),a}var Pt={_driver:"asyncStorage",_initStorage:xt,_support:S(),iterate:It,getItem:St,setItem:Nt,removeItem:Rt,clear:Tt,length:At,key:Dt,keys:Ot,dropInstance:kt};function Ct(){return typeof openDatabase=="function"}var X="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Lt="~~local_forage_type~",We=/^~~local_forage_type~([^~]+)~/,he="__lfsc__:",_e=he.length,Ee="arbf",xe="blob",Ye="si08",ze="ui08",Ve="uic8",Je="si16",je="si32",He="ur16",Ge="ui32",Qe="fl32",Xe="fl64",Ke=_e+Ee.length,Ze=Object.prototype.toString;function qe(e){var n=e.length*.75,t=e.length,o,a=0,r,c,f,l;e[e.length-1]==="="&&(n--,e[e.length-2]==="="&&n--);var h=new ArrayBuffer(n),m=new Uint8Array(h);for(o=0;o<t;o+=4)r=X.indexOf(e[o]),c=X.indexOf(e[o+1]),f=X.indexOf(e[o+2]),l=X.indexOf(e[o+3]),m[a++]=r<<2|c>>4,m[a++]=(c&15)<<4|f>>2,m[a++]=(f&3)<<6|l&63;return h}function Se(e){var n=new Uint8Array(e),t="",o;for(o=0;o<n.length;o+=3)t+=X[n[o]>>2],t+=X[(n[o]&3)<<4|n[o+1]>>4],t+=X[(n[o+1]&15)<<2|n[o+2]>>6],t+=X[n[o+2]&63];return n.length%3===2?t=t.substring(0,t.length-1)+"=":n.length%3===1&&(t=t.substring(0,t.length-2)+"=="),t}function Ft(e,n){var t="";if(e&&(t=Ze.call(e)),e&&(t==="[object ArrayBuffer]"||e.buffer&&Ze.call(e.buffer)==="[object ArrayBuffer]")){var o,a=he;e instanceof ArrayBuffer?(o=e,a+=Ee):(o=e.buffer,t==="[object Int8Array]"?a+=Ye:t==="[object Uint8Array]"?a+=ze:t==="[object Uint8ClampedArray]"?a+=Ve:t==="[object Int16Array]"?a+=Je:t==="[object Uint16Array]"?a+=He:t==="[object Int32Array]"?a+=je:t==="[object Uint32Array]"?a+=Ge:t==="[object Float32Array]"?a+=Qe:t==="[object Float64Array]"?a+=Xe:n(new Error("Failed to get type for BinaryArray"))),n(a+Se(o))}else if(t==="[object Blob]"){var r=new FileReader;r.onload=function(){var c=Lt+e.type+"~"+Se(this.result);n(he+xe+c)},r.readAsArrayBuffer(e)}else try{n(JSON.stringify(e))}catch(c){console.error("Couldn't convert value into a JSON string: ",e),n(null,c)}}function Bt(e){if(e.substring(0,_e)!==he)return JSON.parse(e);var n=e.substring(Ke),t=e.substring(_e,Ke),o;if(t===xe&&We.test(n)){var a=n.match(We);o=a[1],n=n.substring(a[0].length)}var r=qe(n);switch(t){case Ee:return r;case xe:return k([r],{type:o});case Ye:return new Int8Array(r);case ze:return new Uint8Array(r);case Ve:return new Uint8ClampedArray(r);case Je:return new Int16Array(r);case He:return new Uint16Array(r);case je:return new Int32Array(r);case Ge:return new Uint32Array(r);case Qe:return new Float32Array(r);case Xe:return new Float64Array(r);default:throw new Error("Unkown type: "+t)}}var Ie={serialize:Ft,deserialize:Bt,stringToBuffer:qe,bufferToString:Se};function et(e,n,t,o){e.executeSql("CREATE TABLE IF NOT EXISTS "+n.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],t,o)}function Mt(e){var n=this,t={db:null};if(e)for(var o in e)t[o]=typeof e[o]!="string"?e[o].toString():e[o];var a=new u(function(r,c){try{t.db=openDatabase(t.name,String(t.version),t.description,t.size)}catch(f){return c(f)}t.db.transaction(function(f){et(f,t,function(){n._dbInfo=t,r()},function(l,h){c(h)})},c)});return t.serializer=Ie,a}function K(e,n,t,o,a,r){e.executeSql(t,o,a,function(c,f){f.code===f.SYNTAX_ERR?c.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[n.storeName],function(l,h){h.rows.length?r(l,f):et(l,n,function(){l.executeSql(t,o,a,r)},r)},r):r(c,f)},r)}function Ut(e,n){var t=this;e=P(e);var o=new u(function(a,r){t.ready().then(function(){var c=t._dbInfo;c.db.transaction(function(f){K(f,c,"SELECT * FROM "+c.storeName+" WHERE key = ? LIMIT 1",[e],function(l,h){var m=h.rows.length?h.rows.item(0).value:null;m&&(m=c.serializer.deserialize(m)),a(m)},function(l,h){r(h)})})}).catch(r)});return E(o,n),o}function $t(e,n){var t=this,o=new u(function(a,r){t.ready().then(function(){var c=t._dbInfo;c.db.transaction(function(f){K(f,c,"SELECT * FROM "+c.storeName,[],function(l,h){for(var m=h.rows,w=m.length,I=0;I<w;I++){var A=m.item(I),D=A.value;if(D&&(D=c.serializer.deserialize(D)),D=e(D,A.key,I+1),D!==void 0){a(D);return}}a()},function(l,h){r(h)})})}).catch(r)});return E(o,n),o}function tt(e,n,t,o){var a=this;e=P(e);var r=new u(function(c,f){a.ready().then(function(){n===void 0&&(n=null);var l=n,h=a._dbInfo;h.serializer.serialize(n,function(m,w){w?f(w):h.db.transaction(function(I){K(I,h,"INSERT OR REPLACE INTO "+h.storeName+" (key, value) VALUES (?, ?)",[e,m],function(){c(l)},function(A,D){f(D)})},function(I){if(I.code===I.QUOTA_ERR){if(o>0){c(tt.apply(a,[e,l,t,o-1]));return}f(I)}})})}).catch(f)});return E(r,t),r}function Wt(e,n,t){return tt.apply(this,[e,n,t,1])}function Yt(e,n){var t=this;e=P(e);var o=new u(function(a,r){t.ready().then(function(){var c=t._dbInfo;c.db.transaction(function(f){K(f,c,"DELETE FROM "+c.storeName+" WHERE key = ?",[e],function(){a()},function(l,h){r(h)})})}).catch(r)});return E(o,n),o}function zt(e){var n=this,t=new u(function(o,a){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(c){K(c,r,"DELETE FROM "+r.storeName,[],function(){o()},function(f,l){a(l)})})}).catch(a)});return E(t,e),t}function Vt(e){var n=this,t=new u(function(o,a){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(c){K(c,r,"SELECT COUNT(key) as c FROM "+r.storeName,[],function(f,l){var h=l.rows.item(0).c;o(h)},function(f,l){a(l)})})}).catch(a)});return E(t,e),t}function Jt(e,n){var t=this,o=new u(function(a,r){t.ready().then(function(){var c=t._dbInfo;c.db.transaction(function(f){K(f,c,"SELECT key FROM "+c.storeName+" WHERE id = ? LIMIT 1",[e+1],function(l,h){var m=h.rows.length?h.rows.item(0).key:null;a(m)},function(l,h){r(h)})})}).catch(r)});return E(o,n),o}function jt(e){var n=this,t=new u(function(o,a){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(c){K(c,r,"SELECT key FROM "+r.storeName,[],function(f,l){for(var h=[],m=0;m<l.rows.length;m++)h.push(l.rows.item(m).key);o(h)},function(f,l){a(l)})})}).catch(a)});return E(t,e),t}function Ht(e){return new u(function(n,t){e.transaction(function(o){o.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(a,r){for(var c=[],f=0;f<r.rows.length;f++)c.push(r.rows.item(f).name);n({db:e,storeNames:c})},function(a,r){t(r)})},function(o){t(o)})})}function Gt(e,n){n=z.apply(this,arguments);var t=this.config();e=typeof e!="function"&&e||{},e.name||(e.name=e.name||t.name,e.storeName=e.storeName||t.storeName);var o=this,a;return e.name?a=new u(function(r){var c;e.name===t.name?c=o._dbInfo.db:c=openDatabase(e.name,"","",0),e.storeName?r({db:c,storeNames:[e.storeName]}):r(Ht(c))}).then(function(r){return new u(function(c,f){r.db.transaction(function(l){function h(A){return new u(function(D,L){l.executeSql("DROP TABLE IF EXISTS "+A,[],function(){D()},function(C,Y){L(Y)})})}for(var m=[],w=0,I=r.storeNames.length;w<I;w++)m.push(h(r.storeNames[w]));u.all(m).then(function(){c()}).catch(function(A){f(A)})},function(l){f(l)})})}):a=u.reject("Invalid arguments"),E(a,n),a}var Qt={_driver:"webSQLStorage",_initStorage:Mt,_support:Ct(),iterate:$t,getItem:Ut,setItem:Wt,removeItem:Yt,clear:zt,length:Vt,key:Jt,keys:jt,dropInstance:Gt};function Xt(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function nt(e,n){var t=e.name+"/";return e.storeName!==n.storeName&&(t+=e.storeName+"/"),t}function Kt(){var e="_localforage_support_test";try{return localStorage.setItem(e,!0),localStorage.removeItem(e),!1}catch{return!0}}function Zt(){return!Kt()||localStorage.length>0}function qt(e){var n=this,t={};if(e)for(var o in e)t[o]=e[o];return t.keyPrefix=nt(e,n._defaultConfig),Zt()?(n._dbInfo=t,t.serializer=Ie,u.resolve()):u.reject()}function en(e){var n=this,t=n.ready().then(function(){for(var o=n._dbInfo.keyPrefix,a=localStorage.length-1;a>=0;a--){var r=localStorage.key(a);r.indexOf(o)===0&&localStorage.removeItem(r)}});return E(t,e),t}function tn(e,n){var t=this;e=P(e);var o=t.ready().then(function(){var a=t._dbInfo,r=localStorage.getItem(a.keyPrefix+e);return r&&(r=a.serializer.deserialize(r)),r});return E(o,n),o}function nn(e,n){var t=this,o=t.ready().then(function(){for(var a=t._dbInfo,r=a.keyPrefix,c=r.length,f=localStorage.length,l=1,h=0;h<f;h++){var m=localStorage.key(h);if(m.indexOf(r)===0){var w=localStorage.getItem(m);if(w&&(w=a.serializer.deserialize(w)),w=e(w,m.substring(c),l++),w!==void 0)return w}}});return E(o,n),o}function rn(e,n){var t=this,o=t.ready().then(function(){var a=t._dbInfo,r;try{r=localStorage.key(e)}catch{r=null}return r&&(r=r.substring(a.keyPrefix.length)),r});return E(o,n),o}function on(e){var n=this,t=n.ready().then(function(){for(var o=n._dbInfo,a=localStorage.length,r=[],c=0;c<a;c++){var f=localStorage.key(c);f.indexOf(o.keyPrefix)===0&&r.push(f.substring(o.keyPrefix.length))}return r});return E(t,e),t}function an(e){var n=this,t=n.keys().then(function(o){return o.length});return E(t,e),t}function sn(e,n){var t=this;e=P(e);var o=t.ready().then(function(){var a=t._dbInfo;localStorage.removeItem(a.keyPrefix+e)});return E(o,n),o}function cn(e,n,t){var o=this;e=P(e);var a=o.ready().then(function(){n===void 0&&(n=null);var r=n;return new u(function(c,f){var l=o._dbInfo;l.serializer.serialize(n,function(h,m){if(m)f(m);else try{localStorage.setItem(l.keyPrefix+e,h),c(r)}catch(w){(w.name==="QuotaExceededError"||w.name==="NS_ERROR_DOM_QUOTA_REACHED")&&f(w),f(w)}})})});return E(a,t),a}function fn(e,n){if(n=z.apply(this,arguments),e=typeof e!="function"&&e||{},!e.name){var t=this.config();e.name=e.name||t.name,e.storeName=e.storeName||t.storeName}var o=this,a;return e.name?a=new u(function(r){e.storeName?r(nt(e,o._defaultConfig)):r(e.name+"/")}).then(function(r){for(var c=localStorage.length-1;c>=0;c--){var f=localStorage.key(c);f.indexOf(r)===0&&localStorage.removeItem(f)}}):a=u.reject("Invalid arguments"),E(a,n),a}var un={_driver:"localStorageWrapper",_initStorage:qt,_support:Xt(),iterate:nn,getItem:tn,setItem:cn,removeItem:sn,clear:en,length:an,key:rn,keys:on,dropInstance:fn},ln=function(n,t){return n===t||typeof n=="number"&&typeof t=="number"&&isNaN(n)&&isNaN(t)},dn=function(n,t){for(var o=n.length,a=0;a<o;){if(ln(n[a],t))return!0;a++}return!1},rt=Array.isArray||function(e){return Object.prototype.toString.call(e)==="[object Array]"},se={},ot={},re={INDEXEDDB:Pt,WEBSQL:Qt,LOCALSTORAGE:un},hn=[re.INDEXEDDB._driver,re.WEBSQL._driver,re.LOCALSTORAGE._driver],ve=["dropInstance"],Ne=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(ve),vn={description:"",driver:hn.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function mn(e,n){e[n]=function(){var t=arguments;return e.ready().then(function(){return e[n].apply(e,t)})}}function Re(){for(var e=1;e<arguments.length;e++){var n=arguments[e];if(n)for(var t in n)n.hasOwnProperty(t)&&(rt(n[t])?arguments[0][t]=n[t].slice():arguments[0][t]=n[t])}return arguments[0]}var yn=function(){function e(n){g(this,e);for(var t in re)if(re.hasOwnProperty(t)){var o=re[t],a=o._driver;this[t]=a,se[a]||this.defineDriver(o)}this._defaultConfig=Re({},vn),this._config=Re({},this._defaultConfig,n),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return e.prototype.config=function(t){if((typeof t>"u"?"undefined":_(t))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var o in t){if(o==="storeName"&&(t[o]=t[o].replace(/\W/g,"_")),o==="version"&&typeof t[o]!="number")return new Error("Database version must be a number.");this._config[o]=t[o]}return"driver"in t&&t.driver?this.setDriver(this._config.driver):!0}else return typeof t=="string"?this._config[t]:this._config},e.prototype.defineDriver=function(t,o,a){var r=new u(function(c,f){try{var l=t._driver,h=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!t._driver){f(h);return}for(var m=Ne.concat("_initStorage"),w=0,I=m.length;w<I;w++){var A=m[w],D=!dn(ve,A);if((D||t[A])&&typeof t[A]!="function"){f(h);return}}var L=function(){for(var ce=function(bn){return function(){var wn=new Error("Method "+bn+" is not implemented by the current driver"),at=u.reject(wn);return E(at,arguments[arguments.length-1]),at}},Te=0,gn=ve.length;Te<gn;Te++){var Ae=ve[Te];t[Ae]||(t[Ae]=ce(Ae))}};L();var C=function(ce){se[l]&&console.info("Redefining LocalForage driver: "+l),se[l]=t,ot[l]=ce,c()};"_support"in t?t._support&&typeof t._support=="function"?t._support().then(C,f):C(!!t._support):C(!0)}catch(Y){f(Y)}});return R(r,o,a),r},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(t,o,a){var r=se[t]?u.resolve(se[t]):u.reject(new Error("Driver not found."));return R(r,o,a),r},e.prototype.getSerializer=function(t){var o=u.resolve(Ie);return R(o,t),o},e.prototype.ready=function(t){var o=this,a=o._driverSet.then(function(){return o._ready===null&&(o._ready=o._initDriver()),o._ready});return R(a,t,t),a},e.prototype.setDriver=function(t,o,a){var r=this;rt(t)||(t=[t]);var c=this._getSupportedDrivers(t);function f(){r._config.driver=r.driver()}function l(w){return r._extend(w),f(),r._ready=r._initStorage(r._config),r._ready}function h(w){return function(){var I=0;function A(){for(;I<w.length;){var D=w[I];return I++,r._dbInfo=null,r._ready=null,r.getDriver(D).then(l).catch(A)}f();var L=new Error("No available storage method found.");return r._driverSet=u.reject(L),r._driverSet}return A()}}var m=this._driverSet!==null?this._driverSet.catch(function(){return u.resolve()}):u.resolve();return this._driverSet=m.then(function(){var w=c[0];return r._dbInfo=null,r._ready=null,r.getDriver(w).then(function(I){r._driver=I._driver,f(),r._wrapLibraryMethodsWithReady(),r._initDriver=h(c)})}).catch(function(){f();var w=new Error("No available storage method found.");return r._driverSet=u.reject(w),r._driverSet}),R(this._driverSet,o,a),this._driverSet},e.prototype.supports=function(t){return!!ot[t]},e.prototype._extend=function(t){Re(this,t)},e.prototype._getSupportedDrivers=function(t){for(var o=[],a=0,r=t.length;a<r;a++){var c=t[a];this.supports(c)&&o.push(c)}return o},e.prototype._wrapLibraryMethodsWithReady=function(){for(var t=0,o=Ne.length;t<o;t++)mn(this,Ne[t])},e.prototype.createInstance=function(t){return new e(t)},e}(),pn=new yn;d.exports=pn},{3:3}]},{},[4])(4)})})(Fe);var pt=Fe.exports,V=yt(pt);function oe(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,i=>{const s=Math.random()*16|0;return(i==="x"?s:s&3|8).toString(16)})}const te=new EventTarget;self.addEventListener("message",i=>{if(typeof i.data!="string")return;const s=new CustomEvent("message",{detail:JSON.parse(i.data)});te.dispatchEvent(s)});var J={async send(i,s={}){return new Promise(async v=>{const d=oe();postMessage(JSON.stringify({type:i,content:s,id:s.id||d})),te.addEventListener("message",async y=>{y.detail.id!==null&&y.detail.id===d&&(te.removeEventListener("message",y),v(y.detail.content))})})},async sendToWorker(i,s={}){return new Promise((v,d)=>{const y=oe();if(s.id!==void 0&&(s.callback=!0),!i&&s.id===void 0){d(new Error("Target must be specified"));return}postMessage(JSON.stringify({type:"relay",target:i,content:s,id:s.id||y})),te.addEventListener("message",async _=>{_.detail.id!==null&&_.detail.id===y&&(te.removeEventListener("message",_),v(_.detail.content))})})},onMessage:te};class ae{constructor(s){(async()=>{let v=null;if(typeof window>"u"){const d=(await J.send("window")).window.id;self.id=d.id,v=d.id}else self.id!==void 0?v=self.id:v=window.id;this.input=`${s}-${v}`})()}async sha1(){try{return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-1",new TextEncoder("utf-8").encode(this.input)))).map(s=>`00${s.toString(16)}`.slice(-2)).join("")}catch(s){throw`Failed to hash data: ${s.stack}`!==void 0?s.stack:s}}}function gt(){return{list:["log","error","info","trace","warn","debug"],cache:{},logs:[],color:{warn:"yellow",error:"red",log:"limegreen",default:"limegreen"}}}function Be(i){try{return JSON.stringify(i)}catch{return"{ stringify failed }"}}function Me(i){return typeof i=="string"?[i]:typeof i=="object"&&!Array.isArray(i)?[Be(i)]:i.map(s=>typeof s=="object"&&!Array.isArray(s)?Be(s):Array.isArray(s)?Me(s):s).filter(s=>s.length!==0).map(s=>s.toString()).map(s=>s.replace(/\\"/g,'"'))}var bt=i=>{if(console.rewritten!==!0){(i===void 0||i.console===void 0)&&(i={internal:{console:gt()},isDummy:!0});for(const s of i.internal.console.list){i.internal.console.cache[s]=console[s];const{color:v}=i.internal.console;console[s]=(...d)=>{if(d[0]!==void 0&&typeof d[0].startsWith=="function"&&d[0].startsWith("[")&&d[0].includes("]")){let y=`${d[0].split("]")[0]}]`;d[0]=d[0].split("]")[1],y=`%c${y}`,d[0]!==""&&(d[0]=d[0].trimLeft(),d.splice(0,0,"")),i.internal.console.cache[s](`${y}%s`,`color: ${v[s]}`??`${v.default};`,...d)}else if(d.includes("%c"))i.internal.console.cache[s](...d);else{const y="%c[ â“ ] ";i.internal.console.cache[s](y,`color: ${v[s]}`??`${v.default};`,...d)}if(!i.isDummy){const y=Me(d);i.internal.console.logs.push(`[ ${new Date().getTime()-i.internal.timeAtLive}s - ${s.toUpperCase()} ] ${y.join(" ")}`),i.internal.console.logs.length>1e3&&i.internal.console.logs.shift()}}}console.rewritten=!0}};bt();const j={async init(){return j.shared.ready=!0,!0},shared:{ready:!1,filesystem_instances:{},id:null}};ye(j);class wt{constructor(s){this.type=parseInt(s,10),this.id=oe(),this.index=[],this.data={},j.shared.filesystem_instances[this.id]=this}async validate(s,v){return new Promise(async(d,y)=>{try{const g=await new ae(s).sha1();console.debug("[ Filesystem ] Checksum calculation",s,v,g),d(v===g)}catch(_){y(new Error(`Failed to validate checksum: ${_.stack}`))}})}async read(s){return new Promise(async(v,d)=>{try{switch(this.type){case 0:{console.debug("[ Filesystem ] Preparing read task...");const y=JSON.parse(await V.getItem(s));console.debug("[ Filesystem ] Read raw data:",y),console.debug("[ Filesystem ] Validating checksum...");const _={name:y.name,date:y.date};y.data&&(_.data=y.data),await this.validate(JSON.stringify(_),y.checksum)?(console.debug("[ Filesystem ] Checksum valid, read task concluded successfully."),v(y)):d(new Error("Failed to validate read data"));break}default:throw new Error("Unknown filesystem type")}}catch(y){d(new Error(`Failed to read: ${y.stack}`))}})}async writeToIndex(s,v,d){return new Promise(async(y,_)=>{if(s===void 0&&(s=!0),console.log("[ Filesystem ] Preparing index update..."),console.debug("[ Filesystem ] Index snapshot before update:",this.index),console.debug("[ Filesystem] Index entry identifier:",s,"data:",v),!d)if(s===!0){console.debug("[ Filesystem ] Writing to index root...");let x=!1;for(let S of this.index)if(S.i===v.id){x=!0,S=v;break}x||this.index.push(v)}else{console.debug("[ Filesystem ] Writing to folder...");let x=!1,S=!1;const k=(u,E)=>{for(let R=0;R<u.length;R++)if(u[R].t===0&&u[R].id===E)x=!0,u[R]=v;else if(u[R].t===1)if(u[R].i===E){for(let P=0;P<u[R].d.length;P++)u[R].d[P].i===v.i&&(x=!0,u[R].d[P]=v);x||(u[R].d.push(v),S=!0);break}else k(u[R].d,E)};k(this.index,s),!x&&!S&&_(new Error("Cannot find such location"))}const b=await new ae(this.index).sha1();switch(console.debug("[ Filesystem ] Index after update:",this.index),this.type){case 0:{await V.setItem("matikkaeditori-checksums",JSON.stringify(b)),await V.setItem("matikkaeditori-index",JSON.stringify(this.index));break}default:throw new Error("Unknown filesystem type")}console.log("[ Filesystem ] Index update completed successfully."),y()})}async resolveFromIndex(s){if(s===!0)return this.index;const v=d=>{for(const y of d){if(y.i===s)return y;if(y.t===1){const _=v(y.d);if(_!==null)return _}}return null};return v(this.index)}async removeFromIndex(s){if(s===!0)return this.index;const v=d=>{for(const y of d)if(y.i===s&&(d.splice(d.indexOf(y),1),this.writeToIndex(null,null,!0).then(()=>!0)),y.t===1){const _=v(y.d);if(_!==null)return _}return null};return v(this.index)}async limitTreeLevel(s,v){const d=JSON.parse(JSON.stringify(s)),y=(_,g=1)=>{for(const b of _)if(b.t===1){if(v>g)return y(b.d,g+1);b.d=null}return null};return y(d),d}async write(s,v,d){return new Promise(async(y,_)=>{try{switch(this.type){case 0:{console.log("[ Filesystem ] Preparing write task...");let g=JSON.parse(await V.getItem(s));g===null&&(console.debug("[ Filesystem ] No previous entry found."),g={id:s??oe()});const b={name:v.name??g.name,date:v.date??new Date().getTime()};if(v.type===0){b.data=v.data??g.data;const u=await new ae(JSON.stringify({name:b.name,data:b.data,date:b.date})).sha1();b.checksum=u}else{const u=await new ae(JSON.stringify({name:b.name,date:b.date})).sha1();b.checksum=u}console.debug("[ Filesystem ] Write task base:",b),await V.setItem(s??g.id,JSON.stringify(b));const x={t:v.type??g.type,i:s??g.id};await this.resolveFromIndex(s??g.id)||(v.type===1&&(x.d=[]),await this.writeToIndex(d,x)),console.log("[ Filesystem ] Write task completed successfully."),y(s??g.id);break}default:throw new Error("Unknown filesystem type")}}catch(g){console.debug(g),_(new Error(`Failed to write: ${g.stack}`))}})}async remove(s){return new Promise(async(v,d)=>{try{switch(this.type){case 0:{console.log("[ Filesystem ] Preparing remove task..."),await V.getItem(s)!==null?(console.log("[ Filesystem ] Target",s,"exists"),await V.removeItem(s)):console.log("[ Filesystem ] Target not found"),await this.resolveFromIndex(s)!==null&&await this.removeFromIndex(s),console.log("[ Filesystem ] Remove task concluded"),v(!0);break}default:throw new Error("Unknown filesystem type")}}catch(y){d(new Error(`Failed to write: ${y.stack}`))}})}async init(){return new Promise(async(s,v)=>{try{switch(this.type){case 0:{let d=await V.getItem("matikkaeditori-index"),y=await V.getItem("matikkaeditori-checksums");if(d!==null&&y!==null)d=JSON.parse(d),y=JSON.parse(y),await this.validate(d,y)||await J.send("confirm","Someone may have tampered with index data or it may be corrupt. Would you like to load it?")||v(new Error("Filesystem initialization aborted.")),this.index=d,s();else{const _=oe(),g={name:"Tervetuloa!",date:new Date().getTime(),data:["<text>VGVydmV0dWxvYSBrw6R5dHTDpG3DpMOkbiBNYXRpa2thZWRpdG9yaS5maXTDpCEg8J+OiQ==</text>"],checksum:null,type:0},b=new ae({name:g.name,data:g.data,date:g.date});g.checksum=await b.sha1(),await this.write(_,g,!0),console.log("[ Filesystem ] Example file created"),s()}break}default:throw new Error("Unknown filesystem type")}}catch(d){v(new Error(`Failed to initialize filesystem: 
${d.stack}`)),console.debug(d)}})}}J.onMessage.addEventListener("message",async i=>{if(i=i.detail,!!j.shared.ready)switch(i.type){case"init":{const s=new wt(i.content.type);j.shared.filesystem_instances[i.id]=s,await s.init(),J.send("callback",{id:i.id,instance:s.id,index:s.index});break}case"read":{const s=j.shared.filesystem_instances[i.content.instance];if(!s){console.error("No such filesystem instance");break}const v=await s.read(i.content.id);J.send("callback",{id:i.id,read:v});break}case"write":{const s=j.shared.filesystem_instances[i.content.instance];if(!s){console.error("No such filesystem instance");break}const v=await s.write(i.content.id,i.content.write,i.content.location);J.send("callback",{id:i.id,write:v});break}case"callback":break;case"remove":{const s=j.shared.filesystem_instances[i.content.instance];if(!s){console.error("No such filesystem instance");break}await s.remove(i.content.id),J.send("callback",{id:i.id});break}case"move":{const s=j.shared.filesystem_instances[i.content.instance];if(!s){console.error("No such filesystem instance");break}const v=i.content.from,d=i.content.to,y=await s.resolveFromIndex(v);if(!y){console.error("No such location (read)");break}if(await s.removeFromIndex(i.content.id),d!==!0&&!await s.resolveFromIndex(d)){console.error("No such location (write)");break}await s.writeToIndex(d,y);break}case"index":{const s=j.shared.filesystem_instances[i.content.instance];if(!s){console.error("No such filesystem instance");break}if(i.content.id&&i.content.level){const v=await s.resolveFromIndex(i.content.id);let d=null;v!==null&&(d=await s.limitTreeLevel(i.content.id===!0?v:v.d,i.content.level)),J.send("callback",{index:d,id:i.id})}else J.send("callback",{index:s.index,id:i.id});break}case"reset":{await V.clear(),J.send("callback",{id:i.id,status:"ok"});break}default:console.error("[ Filesystem ] Unknown command",i)}})})();
